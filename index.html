<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Coin - Admin Panel</title>
    <style>
        :root {
            --primary: #ff6600;
            --primary-dark: #cc5200;
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-light: #e0e0e0;
            --text-muted: #a0a0a0;
            --success: #00c853;
            --danger: #ff3d00;
            --blue: #2979ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        .hidden { display: none !important; }
        .text-orange { color: var(--primary); }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: white;
            border-radius: 6px;
            outline: none;
        }
        .input-group input:focus { border-color: var(--primary); }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            color: white;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        header {
            background: var(--bg-card);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        
        .section { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .menu-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #333;
        }
        .menu-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .menu-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }

        /* Chat Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 70vh;
        }
        .chat-user-list {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #333;
        }
        .chat-user-item {
            padding: 10px;
            background: #2a2a2a;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-user-item:hover { background: var(--primary); }
        
        /* Unread Badge Style */
        .unread-badge {
            color: #ff0000;
            font-size: 10px;
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #ff0000;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        .chat-box {
            flex: 2;
            background: var(--bg-card);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 8px 12px; border-radius: 10px; font-size: 0.9rem; word-wrap: break-word;}
        .msg-admin { align-self: flex-start; background: #333; color: white; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; }
        .chat-input-area { padding: 10px; display: flex; gap: 10px; border-top: 1px solid #333; }

        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .admin-table th, .admin-table td { text-align: left; padding: 8px; border-bottom: 1px solid #333; }
        .admin-table th { color: var(--primary); }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .status-pending { background: #ff9800; color: black; }
        .status-approved { background: #00c853; color: white; }
        .status-rejected { background: #ff3d00; color: white; }
        .status-banned { background: #333; color: red; border: 1px solid red; }

        .settings-divider {
            margin: 20px 0 10px 0;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            color: var(--primary);
            font-size: 0.9rem;
        }

        /* NEW: Online Indicator for Active Users */
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulseOnline 1.5s infinite;
            box-shadow: 0 0 5px #00ff00;
        }

        @keyframes pulseOnline {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div id="toast-container"></div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        
        <header>
            <div class="logo">
                <i class="fas fa-user-shield"></i> TK Admin
            </div>
        </header>

        <main id="admin-views">
            <section id="view-admin-dashboard" class="section">
                <h2 class="text-orange">Admin Dashboard</h2>
                
                <div class="menu-grid" style="margin-top: 20px;">
                    <div class="menu-card" onclick="window.showAdminSection('market')">
                        <span class="menu-icon text-orange"><i class="fas fa-cogs"></i></span>
                        <div>Settings</div>
                    </div>
                    <div class="menu-card" onclick="window.showAdminSection('deposits')">
                        <span class="menu-icon text-green"><i class="fas fa-check-double"></i></span>
                        <div>Deposits <span id="admin-dep-pending-count" class="badge" style="background:red; padding:2px 5px; border-radius:50%; font-size:0.7rem; color:white;">0</span></div>
                    </div>
                    
                    <div class="menu-card" onclick="window.showAdminSection('withdrawals')">
                        <span class="menu-icon text-blue"><i class="fas fa-money-bill-wave"></i></span>
                        <div>Withdrawals <span id="admin-with-pending-count" class="badge" style="background:red; padding:2px 5px; border-radius:50%; font-size:0.7rem; color:white;">0</span></div>
                    </div>

                    <div class="menu-card" onclick="window.showAdminSection('users')">
                        <span class="menu-icon text-blue"><i class="fas fa-users"></i></span>
                        <div>Users</div>
                    </div>
                    <div class="menu-card" onclick="window.showAdminSection('news')">
                        <span class="menu-icon"><i class="fas fa-newspaper"></i></span>
                        <div>News</div>
                    </div>
                </div>

                <div class="menu-card" onclick="window.showAdminSection('chat')" style="text-align: left; margin-bottom: 20px;">
                    <span class="menu-icon"><i class="fas fa-comments"></i></span>
                    <div>Live Support Chats</div>
                </div>
            </section>

            <!-- Admin: Market & Settings -->
            <section id="admin-market" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">App Settings</h3>
                
                <div style="margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; color: var(--primary); font-size: 0.9rem;">Market Rates</div>
                
                <div class="input-group">
                    <label>TK Price (USDT) - Internal Rate</label>
                    <input type="number" id="admin-tk-price">
                </div>
                <div class="input-group">
                    <label>USDT to PKR Rate (For Display)</label>
                    <input type="number" id="admin-usdt-rate">
                </div>

                <div style="margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; color: var(--primary); font-size: 0.9rem;">Wallet Settings</div>

                <div class="input-group">
                    <label>Minimum Withdraw (TK)</label>
                    <input type="number" id="admin-min-withdraw">
                </div>

                <div class="input-group">
                    <label>Withdraw Fee (%)</label>
                    <input type="number" id="admin-withdraw-fee" step="0.01">
                </div>

                <div style="margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; color: var(--primary); font-size: 0.9rem;">Deposit Details</div>

                <div class="input-group">
                    <label>Easypaisa Number</label>
                    <input type="text" id="admin-easypaisa">
                </div>
                <div class="input-group">
                    <label>JazzCash Number</label>
                    <input type="text" id="admin-jazzcash">
                </div>
                <div class="input-group">
                    <label>Till ID (Raast)</label>
                    <input type="text" id="admin-tillid">
                </div>
                <div class="input-group">
                    <label>QR Code Image URL</label>
                    <input type="text" id="admin-qr-url" placeholder="./qr.png">
                </div>

                <button class="btn" onclick="window.updateAdminSettings()">Save All Settings</button>
            </section>

            <!-- Admin: Deposits -->
            <section id="admin-deposits" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Deposit Approvals</h3>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Method</th>
                                <th>Amount</th>
                                <th>Ref</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="admin-deposit-list">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- NEW SECTION: Withdrawals -->
            <section id="admin-withdrawals" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Withdrawal Requests</h3>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Method</th>
                                <th>Acc/No</th>
                                <th>Amount</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="admin-withdraw-list">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Admin: Users -->
            <section id="admin-users" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">User Management</h3>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Balance</th>
                                <th>Active</th> <!-- NEW: Active Time Column -->
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="admin-user-list">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Admin: News -->
            <section id="admin-news" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Post News</h3>
                <p style="color:#777; font-size:0.8rem; margin-bottom:10px;">Posting this will delete old news.</p>
                <div class="input-group">
                    <label>Headline</label>
                    <input type="text" id="admin-news-headline">
                </div>
                <button class="btn" onclick="window.postNews()">Post Update</button>
            </section>

             <!-- Admin: Chat -->
             <section id="admin-chat" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">User Chats <small style="color:red; font-size:0.7rem;">(Real-time)</small></h3>
                
                <div class="chat-container">
                    <!-- User List -->
                    <div id="admin-chat-list" class="chat-user-list">
                    </div>

                    <!-- Chat Window -->
                    <div id="admin-chat-window" class="chat-box hidden">
                         <div style="padding:10px; border-bottom: 1px solid #333; background:var(--bg-card);">
                             Chatting with: <strong id="chatting-with-name" class="text-orange">--</strong>
                         </div>
                         <div class="chat-messages" id="admin-chat-messages"></div>
                         <div class="chat-input-area">
                             <input type="text" id="admin-chat-input" placeholder="Reply...">
                             <button class="btn btn-sm" onclick="window.adminSendReply()">Reply</button>
                         </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            update, 
            get,
            set
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBMk5ED0YNL9MqVThgMhoOuWvGwTgCJCg",
            authDomain: "injector-c964a.firebaseapp.com",
            databaseURL: "https://injector-c964a-default-rtdb.firebaseio.com",
            projectId: "injector-c964a",
            storageBucket: "injector-c964a.firebasestorage.app",
            messagingSenderId: "746006402839",
            appId: "1:746006402839:web:26d14a3fee7d6e6cc68952",
            measurementId: "G-DBMSEZZWW1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let marketData = { tkPrice: 1.50, usdtRate: 280 };
        let appSettings = { minWithdraw: 50, withdrawFee: 0.05 }; 
        let adminSelectedChatUser = null; 

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--primary)';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function initApp() {
            document.getElementById('app-container').classList.remove('hidden');

            // NEW: Track admin connection status
            onValue(ref(db, '.info/connected'), (snap) => {
                if (snap.val() === true) {
                    console.log("✅ Admin panel connected");
                } else {
                    console.log("❌ Admin panel disconnected");
                }
            });

            onValue(ref(db, 'market'), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    marketData = data;
                }
            });

            onValue(ref(db, 'settings'), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appSettings = data;
                    const minInput = document.getElementById('admin-min-withdraw');
                    if(minInput) minInput.value = appSettings.minWithdraw || 50;

                    const feeInput = document.getElementById('admin-withdraw-fee');
                    if(feeInput) feeInput.value = (appSettings.withdrawFee * 100) || 5;

                    const easypaisaInput = document.getElementById('admin-easypaisa');
                    if(easypaisaInput) easypaisaInput.value = appSettings.easypaisa || '';
                    
                    const jazzInput = document.getElementById('admin-jazzcash');
                    if(jazzInput) jazzInput.value = appSettings.jazzcash || '';

                    const tillInput = document.getElementById('admin-tillid');
                    if(tillInput) tillInput.value = appSettings.tillid || '';

                    const qrInput = document.getElementById('admin-qr-url');
                    if(qrInput) qrInput.value = appSettings.qrUrl || './qr.png';
                }
            });
        }

        // EXPLICITLY BIND FUNCTIONS TO WINDOW FOR HTML onclick handlers
        window.showAdminSection = (sectionId) => {
            document.querySelectorAll('#admin-views .section').forEach(el => el.classList.add('hidden'));
            if(sectionId === 'dashboard') document.getElementById('view-admin-dashboard').classList.remove('hidden');
            else document.getElementById(`admin-${sectionId}`).classList.remove('hidden');
            if (sectionId === 'deposits') loadAdminDeposits();
            if (sectionId === 'withdrawals') loadAdminWithdrawals();
            if (sectionId === 'users') loadAdminUsers();
            if (sectionId === 'market') loadAdminMarket();
            if (sectionId === 'chat') loadAdminChatList();
        };

        function loadAdminMarket() {
            document.getElementById('admin-tk-price').value = marketData.tkPrice;
            document.getElementById('admin-usdt-rate').value = marketData.usdtRate;
            document.getElementById('admin-min-withdraw').value = appSettings.minWithdraw || 50;
            document.getElementById('admin-withdraw-fee').value = (appSettings.withdrawFee * 100) || 5;
            document.getElementById('admin-easypaisa').value = appSettings.easypaisa || '0300-1234567';
            document.getElementById('admin-jazzcash').value = appSettings.jazzcash || '0321-7654321';
            document.getElementById('admin-tillid').value = appSettings.tillid || '03XX-XXXXXXX (Raast)';
            document.getElementById('admin-qr-url').value = appSettings.qrUrl || './qr.png';
        }

        window.updateAdminSettings = () => {
            const price = parseFloat(document.getElementById('admin-tk-price').value);
            const rate = parseFloat(document.getElementById('admin-usdt-rate').value);
            const minWithdraw = parseFloat(document.getElementById('admin-min-withdraw').value);
            
            const easypaisa = document.getElementById('admin-easypaisa').value;
            const jazzcash = document.getElementById('admin-jazzcash').value;
            const tillid = document.getElementById('admin-tillid').value;
            const qrUrl = document.getElementById('admin-qr-url').value;
            
            const withdrawFeePercent = parseFloat(document.getElementById('admin-withdraw-fee').value);
            const withdrawFeeDecimal = withdrawFeePercent / 100;

            const updates = {};
            updates['market/tkPrice'] = price;
            updates['market/usdtRate'] = rate;
            updates['market/mode'] = 'manual';
            updates['settings/minWithdraw'] = minWithdraw;
            updates['settings/withdrawFee'] = withdrawFeeDecimal; 
            updates['settings/easypaisa'] = easypaisa;
            updates['settings/jazzcash'] = jazzcash;
            updates['settings/tillid'] = tillid;
            updates['settings/qrUrl'] = qrUrl;

            update(ref(db), updates).then(() => {
                showToast("Settings Updated");
            });
        }

        function loadAdminDeposits() {
            const list = document.getElementById('admin-deposit-list');
            onValue(ref(db, 'deposits'), (snapshot) => {
                const data = snapshot.val();
                list.innerHTML = "";
                if(data) {
                    let count = 0;
                    Object.keys(data).forEach((key) => {
                        const item = data[key];
                        if(item.status === 'pending') count++;
                        list.innerHTML += `
                            <tr>
                                <td>${item.userEmail}</td>
                                <td>${item.method}</td>
                                <td>${item.amount.toFixed(2)} TK</td>
                                <td>${item.ref}</td>
                                <td>
                                    ${item.status === 'pending' ? `
                                    <button class="btn btn-sm" style="background:var(--success)" onclick="window.approveDep('${key}', '${item.userId}', ${item.amount})"><i class="fas fa-check"></i></button>
                                    <button class="btn btn-sm" style="background:var(--danger)" onclick="window.rejectDep('${key}')"><i class="fas fa-times"></i></button>
                                    ` : `<span class="status-badge status-${item.status}">${item.status}</span>`}
                                </td>
                            </tr>
                        `;
                    });
                    document.getElementById('admin-dep-pending-count').innerText = count;
                }
            });
        }

        window.approveDep = (key, uid, amount) => {
            const updates = {};
            get(ref(db, 'users/' + uid)).then(snap => {
                const curBal = snap.val().balanceTK;
                updates['users/' + uid + '/balanceTK'] = curBal + amount;
                updates['deposits/' + key + '/status'] = 'approved';
                
                update(ref(db), updates).then(() => {
                    showToast("Deposit Approved");
                });
            });
        };
        
        window.rejectDep = (key) => {
            update(ref(db, 'deposits/' + key), {
                status: 'rejected'
            }).then(() => {
                showToast("Deposit Rejected");
            });
        };
        
        // FIXED: Simplified Rendering using String HTML and Window scope
        function loadAdminWithdrawals() {
            const list = document.getElementById('admin-withdraw-list');
            if(!list) return; // Safety check

            onValue(ref(db, 'withdrawals'), (snapshot) => {
                const data = snapshot.val();
                list.innerHTML = ""; // Clear list
                
                if (!data) {
                    list.innerHTML = "<tr><td colspan='6' style='text-align:center; color:#777;'>No requests found.</td></tr>";
                    document.getElementById('admin-with-pending-count').innerText = 0;
                    return;
                }

                let count = 0;
                let html = "";

                Object.keys(data).forEach((key) => {
                    const item = data[key];
                    if(!item) return; // Skip if item is null/undefined

                    if (item.status === 'pending') count++;

                    html += `
                        <tr>
                            <td>${item.userEmail || 'Unknown'}</td>
                            <td>${item.method || 'Unknown'}</td>
                            <td>${item.account || 'Unknown'}</td>
                            <td>${(item.amount || 0).toFixed(2)}</td>
                            <td>${(item.total || 0).toFixed(2)}</td>
                            <td>
                                ${item.status === 'pending' ? `
                                    <button class="btn btn-sm" style="background:var(--success)" onclick="window.approveWithdraw('${key}')"><i class="fas fa-check"></i></button>
                                    <button class="btn btn-sm" style="background:var(--danger)" onclick="window.rejectWithdraw('${key}', '${item.userId}', ${item.total})"><i class="fas fa-times"></i></button>
                                ` : `<span class="status-badge status-${item.status}">${item.status}</span>`}
                            </td>
                        </tr>
                    `;
                });

                list.innerHTML = html;
                document.getElementById('admin-with-pending-count').innerText = count;
            });
        }

        // FIXED: Simple Status Update (Balance already deducted by user)
        window.approveWithdraw = (key) => {
            update(ref(db, 'withdrawals/' + key), {
                status: 'approved'
            }).then(() => {
                showToast("Withdrawal Approved");
                // List auto-refreshes via onValue
            });
        };

        // FIXED: Refund Balance on Reject
        window.rejectWithdraw = (key, uid, totalRefundAmount) => {
            get(ref(db, 'users/' + uid)).then(snap => {
                if(!snap.exists()) return showToast("User not found", "error");
                
                const curBal = snap.val().balanceTK;
                const newBal = curBal + totalRefundAmount;

                const updates = {};
                updates['users/' + uid + '/balanceTK'] = newBal;
                updates['withdrawals/' + key + '/status'] = 'rejected';
                
                update(ref(db), updates).then(() => {
                    showToast("Withdrawal Rejected & Refunded");
                    // List auto-refreshes
                });
            });
        };
        
        // UPDATED: Now includes Live Active Time
        function loadAdminUsers() {
            const list = document.getElementById('admin-user-list');
            onValue(ref(db, 'users'), (snapshot) => {
                const data = snapshot.val();
                list.innerHTML = "";
                if(data) {
                    Object.keys(data).forEach((uid) => {
                        const u = data[uid];
                        const isBanned = u.isBanned || false;
                        const banBtnStyle = isBanned ? "background:#555; cursor:not-allowed" : "background:var(--danger)";
                        const banText = isBanned ? "Banned" : "Ban Account";
                        
                        // Calculate active time
                        let activeStatus = '<span style="color:#777;">Never</span>';
                        if(u.lastActive) {
                            const lastActive = new Date(u.lastActive).getTime();
                            const now = Date.now();
                            const diffMin = Math.floor((now - lastActive) / 60000);
                            
                            if(diffMin < 1) {
                                activeStatus = '<span class="online-indicator"></span> Online';
                            } else if(diffMin < 60) {
                                activeStatus = `<span style="color:#FFD700;">${diffMin} min ago</span>`;
                            } else if(diffMin < 1440) {
                                activeStatus = `<span style="color:#FFA500;">${Math.floor(diffMin/60)}h ago</span>`;
                            } else {
                                activeStatus = `<span style="color:#777;">${Math.floor(diffMin/1440)}d ago</span>`;
                            }
                        }

                        list.innerHTML += `
                            <tr>
                                <td>${u.name}</td>
                                <td>${u.email}</td>
                                <td>${u.password || '---'}</td>
                                <td>${u.balanceTK}</td>
                                <td>${activeStatus}</td>
                                <td>
                                    <button class="btn btn-sm" style="${banBtnStyle}" onclick="window.banUser('${uid}', ${isBanned})">${banText}</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            });
        }

        window.banUser = (uid, isAlreadyBanned) => {
            if(isAlreadyBanned) {
                showToast("User is already banned", "error");
                return;
            }
            if(confirm("Are you sure you want to ban this user?")) {
                update(ref(db, 'users/' + uid), {
                    isBanned: true
                }).then(() => showToast("User Banned"));
            }
        }

        window.postNews = () => {
            const title = document.getElementById('admin-news-headline').value;
            if(title) {
                set(ref(db, 'news'), null).then(() => {
                    push(ref(db, 'news'), {
                        title: title,
                        date: new Date().toLocaleDateString()
                    }).then(() => {
                        showToast("News Posted (Old Deleted)");
                        document.getElementById('admin-news-headline').value = "";
                    });
                });
            }
        }
        
        function loadAdminChatList() {
            const list = document.getElementById('admin-chat-list');
            list.innerHTML = '<div style="padding:10px; text-align:center; color:#777;">Loading users...</div>';

            onValue(ref(db, 'users'), (snapshot) => {
                const data = snapshot.val();
                list.innerHTML = "";
                if(data) {
                    Object.keys(data).forEach((uid) => {
                        const u = data[uid];
                        const item = document.createElement('div');
                        item.className = 'chat-user-item';
                        item.id = `chat-user-${uid}`; 
                        item.innerHTML = `<span><i class="fas fa-user-circle"></i> ${u.name}</span>`;
                        item.onclick = () => selectAdminChatUser(uid, u.name);
                        list.appendChild(item);

                        const chatRef = ref(db, 'chats/' + uid);
                        onValue(chatRef, (chatSnap) => {
                            const chatData = chatSnap.val();
                            if(chatData) {
                                const msgKeys = Object.keys(chatData);
                                const lastKey = msgKeys[msgKeys.length - 1];
                                const lastMsg = chatData[lastKey];

                                if(lastMsg.sender !== 'admin' && adminSelectedChatUser !== uid) {
                                    const badgeSpan = `<span class="unread-badge"></span>`;
                                    const existingBadge = document.getElementById(`chat-user-${uid}`).querySelector('.unread-badge');
                                    if(!existingBadge) document.getElementById(`chat-user-${uid}`).innerHTML += badgeSpan;
                                } else {
                                    const existingBadge = document.getElementById(`chat-user-${uid}`).querySelector('.unread-badge');
                                    if(existingBadge) existingBadge.remove();
                                }
                            }
                        });
                    });
                }
            });
        }

        function selectAdminChatUser(uid, name) {
            adminSelectedChatUser = uid;
            document.getElementById('chatting-with-name').innerText = name;
            
            const userItem = document.getElementById(`chat-user-${uid}`);
            if(userItem) {
                const badge = userItem.querySelector('.unread-badge');
                if(badge) badge.remove();
            }

            document.getElementById('admin-chat-window').classList.remove('hidden');

            const chatRef = ref(db, 'chats/' + uid);
            onValue(chatRef, (snapshot) => {
                const container = document.getElementById('admin-chat-messages');
                container.innerHTML = "";
                const data = snapshot.val();
                
                if (!data) {
                    container.innerHTML = `<div style="text-align:center; color:#777; margin-top:20px;">No messages yet.</div>`;
                    return;
                }

                Object.values(data).forEach(msg => {
                    const div = document.createElement('div');
                    const isAdminMsg = msg.sender === 'admin';
                    div.className = `message ${isAdminMsg ? 'msg-admin' : 'msg-user'}`;
                    div.innerText = msg.text;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        window.adminSendReply = () => {
            const input = document.getElementById('admin-chat-input');
            const text = input.value;
            if(!text || !adminSelectedChatUser) return;

            push(ref(db, 'chats/' + adminSelectedChatUser), {
                sender: 'admin',
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
        }

        initApp();
    </script>
</body>
</html>
